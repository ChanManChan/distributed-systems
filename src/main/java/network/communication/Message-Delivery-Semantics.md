## Message delivery semantics in distributed systems

1. Successful scenario
   > Client sends request -> Server receives request -> Executes -> Responds back to client with result -> Client receives the response from server
2. Network Failure
   > Client sends request -> Server receives request -> Executes -> Responds back to client with result -> Network communication breaks (Client never receives the acknowledgment that the action was successfully performed)
3. Server crash after execution
4. Server crash before execution
5. Server crash before receiving the request

From the client's perspective all these scenarios looks the same

**Example**:- User purchase transaction

Order service receives purchase request from the user and sends a request to the billing service to withdraw money from
the users bank account. After the order service sent a request to the billing service the order service never receives
any response from the billing service.

_**What should we do?**_

* **Option1**:- Resend the request to the billing service again and potentially bill the user twice
* **Option2**:- Do not resend the request to the billing service and potentially not billing the user at all and lose
  money

We need to agree on the delivery semantics between the client and the server ahead of time. What we really want is
Exactly Once delivery semantics, but it is very hard to achieve and sometimes is even impossible.

### At Most Once Semantics

The client sends a request to the server only once. If the server never receives a response or the server crashes right
before it sends back the response the client will never redeliver the request to the server.

_Worst case_:- The action may never get performed by the server
_Best case_:- The action is performed only once

**_Use cases_**-

1. Messages to a logging or monitoring service. It's ok to lose some messages, and it's not worth redelivery.
2. Sending promotional emails/notifications to users. If a user never receives a promotion - no harm is done. If a user
   receives multiple notifications about the same promotion, user may get frustrated and unsubscribe.

### At Least Once Semantics

If the client does not receive a response it will keep resending the request until it gets a response. If the server did
perform the requested action, but failed to respond, the operation will be executed multiple times. This delivery
semantics works only for idempotent operations

```
Idempotent Operation definition:-
An operation that can be performed multiple times, and will have the same result/effect as if it was performed only once.

Idempotent operation examples:
1. Read the first line in a file.
2. Update the status of a user to "active".
3. Delete a record by its ID

These operations are completely safe to perform using At Least Once Semantics because performing those operations
multiple times will yield the same result.

Non-idempotent operations examples:
1. Appending a line to a file.
2. Incrementing a metric in a database
3. Withdrawing money from a user's account.

These operations are unsafe to perform using the At Least Once Semantics. 
Performing those operations more than once will have adverse and undesired effect on the system.
```

**_What to do when an operation is not idempotent?_** </br>

* Losing the operation is out of the question.
* Then we have to make the non-idempotent operation, idempotent artificially.
* We can use a monotonically increasing sequence number generated by the client to augment a non-idempotent operation to
  make it artificially idempotent.

**_Why do we need to choose between At Least Once and At Most Once message delivery semantics?_** </br>
In a normal situation, the message sent from client to the server is delivered once. However, in case of an unexpected
failure

1. The message may be lost
2. Not processed properly on the server
3. The response with the confirmation may be lost.

The delivery semantics is the contract between the server and the client about what to do in such a failure. So we are
forced to choose to either retransmit the message (_At Least Once Semantics_) or not to transmit the message(_At Most
Once Semantics_). We are forced to choose between the 2 only to prepare for a failure situation, and agree between the
client and server what is going to be done in such a case.